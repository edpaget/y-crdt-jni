name: Publish Javadoc

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-javadoc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 22
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '22'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Generate Javadoc for all modules (excluding Panama)
        run: ./gradlew javadoc -x :ycrdt-panama:javadoc

      - name: Create documentation directory structure
        run: |
          mkdir -p docs-site
          mkdir -p docs-site/ycrdt-core
          mkdir -p docs-site/ycrdt-jni
          mkdir -p docs-site/yprosemirror
          mkdir -p docs-site/yhocuspocus
          mkdir -p docs-site/yhocuspocus-websocket
          mkdir -p docs-site/yhocuspocus-spring-websocket

      - name: Copy Javadoc for all modules
        run: |
          cp -r ycrdt-core/build/docs/javadoc/* docs-site/ycrdt-core/
          cp -r ycrdt-jni/build/docs/javadoc/* docs-site/ycrdt-jni/
          cp -r yprosemirror/build/docs/javadoc/* docs-site/yprosemirror/
          cp -r yhocuspocus/build/docs/javadoc/* docs-site/yhocuspocus/
          cp -r yhocuspocus-websocket/build/docs/javadoc/* docs-site/yhocuspocus-websocket/
          cp -r yhocuspocus-spring-websocket/build/docs/javadoc/* docs-site/yhocuspocus-spring-websocket/

      - name: Create index page
        run: |
          cat > docs-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Y-CRDT JNI Documentation</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
              }
              h1 {
                color: #333;
                border-bottom: 2px solid #e0e0e0;
                padding-bottom: 10px;
              }
              .module {
                margin: 30px 0;
                padding: 20px;
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                background-color: #f9f9f9;
              }
              .module h2 {
                margin-top: 0;
                color: #0066cc;
              }
              .module p {
                color: #666;
                margin: 10px 0;
              }
              .module a {
                display: inline-block;
                margin-top: 10px;
                padding: 8px 16px;
                background-color: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 3px;
              }
              .module a:hover {
                background-color: #0052a3;
              }
              .links {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
              }
              .links a {
                margin-right: 15px;
                color: #0066cc;
              }
            </style>
          </head>
          <body>
            <h1>Y-CRDT JNI Documentation</h1>
            <p>Java bindings for Y-CRDT with multi-module architecture.</p>

            <div class="module">
              <h2>ycrdt-core</h2>
              <p>Core Y-CRDT interfaces and abstract classes for implementation-agnostic usage.</p>
              <a href="ycrdt-core/index.html">View Javadoc</a>
            </div>

            <div class="module">
              <h2>ycrdt-jni</h2>
              <p>JNI-based Y-CRDT bindings with Rust native library. Provides YDoc, YText, YArray, YMap, YXmlText, YXmlElement, YXmlFragment.</p>
              <a href="ycrdt-jni/index.html">View Javadoc</a>
            </div>

            <div class="module">
              <h2>yprosemirror</h2>
              <p>ProseMirror integration providing bidirectional sync between ProseMirror documents and Y-CRDT.</p>
              <a href="yprosemirror/index.html">View Javadoc</a>
            </div>

            <div class="module">
              <h2>yhocuspocus</h2>
              <p>Transport-agnostic collaborative editing server for Y-CRDT synchronization.</p>
              <a href="yhocuspocus/index.html">View Javadoc</a>
            </div>

            <div class="module">
              <h2>yhocuspocus-websocket</h2>
              <p>WebSocket transport implementation for yhocuspocus using Jetty 12.</p>
              <a href="yhocuspocus-websocket/index.html">View Javadoc</a>
            </div>

            <div class="module">
              <h2>yhocuspocus-spring-websocket</h2>
              <p>Spring WebSocket transport implementation for yhocuspocus.</p>
              <a href="yhocuspocus-spring-websocket/index.html">View Javadoc</a>
            </div>

            <div class="links">
              <a href="https://github.com/edpaget/y-crdt-jni">GitHub Repository</a>
              <a href="https://github.com/edpaget/y-crdt-jni/blob/main/README.md">README</a>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'docs-site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-javadoc
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
